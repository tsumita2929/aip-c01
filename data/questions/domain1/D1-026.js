window.DOMAIN1_QUESTIONS = window.DOMAIN1_QUESTIONS || [];
window.DOMAIN1_QUESTIONS.push({
  "id": "D1-026",
  "domain": 1,
  "task": "1.3",
  "skill": "1.3.3",
  "type": "single",
  "difficulty": "medium",
  "question": "ある旅行会社が、Amazon Bedrock の Converse API を使用して旅行プラン提案チャットボットを構築しています。チャットボットはマルチターン会話で顧客の好みを段階的にヒアリングし、最終的に旅行プランを提案します。しかし、会話が長くなるとトークン数がモデルのコンテキストウィンドウ上限（200Kトークン）に近づき、API がエラーを返す問題が発生しています。会話の文脈を維持しつつ、長時間の会話でもエラーを防止するアーキテクチャとして最も適切なのはどれですか？",
  "options": [
    {
      "id": "A",
      "text": "Converse API の messages 配列に完全な会話履歴を送信する方式を維持しつつ、古いメッセージを Bedrock FM で要約して要約テキストを system プロンプトに含める。直近N件のメッセージのみを messages 配列に保持し、トークン数を管理する"
    },
    {
      "id": "B",
      "text": "会話履歴を DynamoDB に保存し、各ターンでは直近1件のユーザーメッセージのみを Converse API に送信する。FM の応答を受け取ったら DynamoDB に追記し、次のターンでも直近1件のみ送信する"
    },
    {
      "id": "C",
      "text": "Converse API の maxTokens パラメータを最大値に設定し、FM の応答トークン数を増やす。同時に temperature を0に設定して応答の一貫性を確保する"
    },
    {
      "id": "D",
      "text": "会話が一定のトークン数に達したら新しいセッション ID で Converse API を呼び出し、新しい会話を開始する。前のセッションのコンテキストは system プロンプトに「前回の会話の続きです」と記載する"
    }
  ],
  "correctAnswers": [
    "A"
  ],
  "explanation": "Converse API の messages 配列で会話履歴を管理する際、古いメッセージを FM で要約して system プロンプトに含め、直近のメッセージのみを messages 配列に保持する方式（スライディングウィンドウ + 要約）が最も適切です。これにより、過去の会話の文脈を要約テキストとして維持しつつ、トークン数をコンテキストウィンドウ内に収められます。直近1件のみ送信（B）では、過去の会話コンテキスト（顧客の好み、予算、日程等）が完全に失われ、各ターンが独立した質問応答になってしまいます。DynamoDB に保存しても FM に渡さなければ文脈の維持にはなりません。maxTokens パラメータ（C）は FM の応答の最大トークン数を制御するもので、入力のコンテキストウィンドウ制限とは無関係です。入力側のトークン数がモデルの上限を超えるエラーには対処できません。新しいセッション開始（D）では、前の会話で蓄積された顧客の好み・制約条件が引き継がれません。「前回の会話の続きです」というテキストだけでは具体的な情報が含まれず、FM は前のセッションの詳細を知ることができません。（スキル1.3.3）",
  "optionExplanations": {
    "A": {
      "correct": true,
      "text": "正解です。古いメッセージの要約をsystemプロンプトに含め、直近のメッセージのみをmessages配列に保持するスライディングウィンドウ方式により、過去の会話文脈を維持しつつトークン数をコンテキストウィンドウ内に管理できます。旅行プラン提案に必要な顧客の好み・予算・日程などの情報を要約に含めることで、長時間会話でも品質を維持できます。"
    },
    "B": {
      "correct": false,
      "text": "不正解です。DynamoDB への保存は会話履歴の永続化には有用ですが、各ターンで直近1件のみをFMに送信すると、過去に蓄積された顧客の好み・予算・日程等のコンテキストが失われます。FMは直前の発話しか知らない状態になり、一貫性のある旅行プラン提案ができません。"
    },
    "C": {
      "correct": false,
      "text": "不正解です。maxTokens は FM の応答（出力）の最大トークン数を制御するパラメータであり、入力側のトークン数制限（コンテキストウィンドウ）とは別の概念です。会話履歴が入力のコンテキストウィンドウ上限を超えるエラーに対しては効果がありません。"
    },
    "D": {
      "correct": false,
      "text": "不正解です。新しいセッションを開始すると、FMのコンテキストがリセットされます。system プロンプトに「前回の会話の続きです」と記載しても、具体的な情報（顧客が希望した目的地、予算上限、旅行日程等）が含まれないため、FMは前のセッションの詳細を推測できず、会話の連続性が失われます。"
    }
  },
  "references": [
    {
      "title": "Amazon Bedrock Converse API",
      "url": "https://docs.aws.amazon.com/bedrock/latest/userguide/conversation-inference.html"
    }
  ]
});
